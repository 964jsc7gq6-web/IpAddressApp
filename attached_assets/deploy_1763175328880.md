# Guia de Deploy - Supply TREE

Este guia fornece instru√ß√µes passo a passo para fazer deploy da aplica√ß√£o Supply TREE em ambiente local e em servidor EC2 na AWS.

## üìã Pr√©-requisitos

- Node.js 18 ou superior
- PostgreSQL 14 ou superior
- Git

---

## üè† Deploy Local (Ambiente de Desenvolvimento)

### Passo 1: Clone o Reposit√≥rio

```bash
git clone <url-do-repositorio>
cd supply-tree
```

### Passo 2: Instale as Depend√™ncias

```bash
npm install
```

### Passo 3: Configure o Banco de Dados PostgreSQL

#### Op√ß√£o A: PostgreSQL Local

1. Instale o PostgreSQL na sua m√°quina
2. Crie um banco de dados:

```bash
# Entre no PostgreSQL
psql -U postgres

# Crie o banco de dados
CREATE DATABASE supplytree;

# Crie um usu√°rio (opcional)
CREATE USER supplytree_user WITH ENCRYPTED PASSWORD 'sua_senha_segura';
GRANT ALL PRIVILEGES ON DATABASE supplytree TO supplytree_user;
\q
```

### Passo 4: Configure as Vari√°veis de Ambiente

Crie um arquivo `.env` na raiz do projeto:

```bash
cp .env.example .env
```

Edite o arquivo `.env`:

```env
# Database Configuration
DATABASE_URL=postgresql://postgres:sua_senha@localhost:5432/supplytree

# Server Configuration
NODE_ENV=development
PORT=5000
HOST=0.0.0.0

# Session Configuration (gere uma senha aleat√≥ria forte)
SESSION_SECRET=minha-chave-secreta-super-segura-mudar-em-producao

# CORS Configuration
ALLOWED_ORIGINS=http://localhost:5000

# Application URL
APP_URL=http://localhost:5000

# Trust Proxy
TRUST_PROXY=false
```

**‚ö†Ô∏è IMPORTANTE:** Nunca compartilhe o arquivo `.env` ou fa√ßa commit dele no Git!

### Passo 5: Inicialize o Banco de Dados

```bash
# Aplica o schema do banco de dados
npm run db:push

# Popula o banco com dados de demonstra√ß√£o
npm run db:seed
```

### Passo 6: Inicie a Aplica√ß√£o

```bash
npm run dev
```

A aplica√ß√£o estar√° dispon√≠vel em: `http://localhost:5000`

### Contas de Demonstra√ß√£o

Ap√≥s executar o seed, voc√™ pode fazer login com:

- **Admin**: admin@supplytree.local / supply123
- **√ìrg√£o Comprador**: orgao@supplytree.local / supply123
- **Aprovador**: aprovador@supplytree.local / supply123
- **Fornecedor**: fornecedor@supplytree.local / supply123

---

## ‚òÅÔ∏è Deploy em Servidor EC2 (AWS)

### Parte 1: Configura√ß√£o da Inst√¢ncia EC2

#### Passo 1: Crie uma Inst√¢ncia EC2

1. Acesse o [Console da AWS EC2](https://console.aws.amazon.com/ec2)
2. Clique em "Launch Instance"
3. Configure:
   - **AMI**: Ubuntu Server 22.04 LTS
   - **Instance Type**: t3.micro (ou superior para produ√ß√£o)
   - **Key Pair**: Crie ou selecione uma chave SSH
   - **Network Settings**:
     - Criar Security Group com as seguintes regras:
       - SSH (Port 22) - Apenas seu IP
       - HTTP (Port 80) - 0.0.0.0/0
       - HTTPS (Port 443) - 0.0.0.0/0
   - **Storage**: 20 GB ou mais

4. Clique em "Launch Instance"

#### Passo 2: Conecte-se √† Inst√¢ncia

```bash
# Ajuste permiss√µes da chave
chmod 400 sua-chave.pem

# Conecte via SSH
ssh -i sua-chave.pem ubuntu@<IP-PUBLICO-EC2>
```

### Parte 2: Instala√ß√£o de Depend√™ncias

#### Passo 3: Atualize o Sistema

```bash
sudo apt update
sudo apt upgrade -y
```

#### Passo 4: Instale o Node.js

```bash
# Instale o NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# Carregue o NVM
source ~/.nvm/nvm.sh

# Instale o Node.js LTS
nvm install --lts

# Verifique a instala√ß√£o
node -v
npm -v
```

#### Passo 5: Instale o PostgreSQL

```bash
# Instale o PostgreSQL
sudo apt install postgresql postgresql-contrib -y

# Inicie o PostgreSQL
sudo systemctl start postgresql
sudo systemctl enable postgresql

# Configure o banco de dados
sudo -u postgres psql

# No prompt do PostgreSQL:
CREATE DATABASE supplytree;
CREATE USER supplytree_user WITH ENCRYPTED PASSWORD 'SUA_SENHA_FORTE_AQUI';
GRANT ALL PRIVILEGES ON DATABASE supplytree TO supplytree_user;
\q
```

#### Passo 6: Instale o PM2 (Process Manager)

```bash
sudo npm install -g pm2
```

#### Passo 7: Instale o Nginx

```bash
sudo apt install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx
```

### Parte 3: Deploy da Aplica√ß√£o

#### Passo 8: Clone e Configure a Aplica√ß√£o

```bash
# Clone o reposit√≥rio
cd ~
git clone <url-do-repositorio> supply-tree
cd supply-tree

# Instale as depend√™ncias
npm install --production
```

#### Passo 9: Configure as Vari√°veis de Ambiente

```bash
# Crie o arquivo .env
nano .env
```

Cole o seguinte conte√∫do (ajuste os valores):

```env
# Database Configuration
DATABASE_URL=postgresql://supplytree_user:SUA_SENHA_FORTE_AQUI@localhost:5432/supplytree

# Server Configuration
NODE_ENV=production
PORT=5000
HOST=localhost

# Session Configuration (GERE UMA SENHA ALEAT√ìRIA FORTE!)
SESSION_SECRET=gere-uma-senha-super-segura-e-aleatoria-aqui-min-32-caracteres

# CORS Configuration (substitua pelo seu dom√≠nio)
ALLOWED_ORIGINS=https://seudominio.com,https://www.seudominio.com

# Application URL (substitua pelo seu dom√≠nio)
APP_URL=https://seudominio.com

# Trust Proxy (necess√°rio quando usando nginx)
TRUST_PROXY=true
```

**üí° Dica:** Gere uma SESSION_SECRET segura:
```bash
openssl rand -base64 32
```

Salve e feche (Ctrl+X, Y, Enter).

#### Passo 10: Build da Aplica√ß√£o

```bash
npm run build
```

#### Passo 11: Inicialize o Banco de Dados

```bash
# Aplica o schema
npm run db:push

# Popula com dados de demonstra√ß√£o (opcional)
npm run db:seed
```

#### Passo 12: Inicie a Aplica√ß√£o com PM2

```bash
# Inicie a aplica√ß√£o
pm2 start npm --name "supply-tree" -- start

# Configure para iniciar automaticamente ap√≥s reboot
pm2 startup
# Execute o comando que o PM2 sugerir (geralmente come√ßa com sudo)

# Salve a configura√ß√£o
pm2 save

# Verifique o status
pm2 status
pm2 logs supply-tree
```

### Parte 4: Configura√ß√£o do Nginx (Reverse Proxy)

#### Passo 13: Configure o Nginx

```bash
# Crie o arquivo de configura√ß√£o
sudo nano /etc/nginx/sites-available/supply-tree
```

Cole o seguinte conte√∫do (substitua `seudominio.com` pelo seu dom√≠nio):

```nginx
upstream nodejs_backend {
    server localhost:5000;
    keepalive 64;
}

server {
    listen 80;
    listen [::]:80;
    server_name seudominio.com www.seudominio.com;

    # Tamanho m√°ximo de upload
    client_max_body_size 10M;

    location / {
        proxy_pass http://nodejs_backend;
        proxy_http_version 1.1;
        
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_cache_bypass $http_upgrade;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Compress√£o Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
}
```

Salve e feche.

#### Passo 14: Ative a Configura√ß√£o

```bash
# Crie um link simb√≥lico
sudo ln -s /etc/nginx/sites-available/supply-tree /etc/nginx/sites-enabled/

# Remova a configura√ß√£o padr√£o
sudo rm /etc/nginx/sites-enabled/default

# Teste a configura√ß√£o
sudo nginx -t

# Recarregue o nginx
sudo systemctl reload nginx
```

Neste ponto, sua aplica√ß√£o j√° deve estar acess√≠vel via HTTP em `http://seu-ip-publico` ou `http://seudominio.com`.

### Parte 5: Configura√ß√£o de SSL/HTTPS com Let's Encrypt

#### Passo 15: Instale o Certbot

```bash
sudo apt install certbot python3-certbot-nginx -y
```

#### Passo 16: Obtenha o Certificado SSL

**‚ö†Ô∏è IMPORTANTE:** Antes de executar este comando:
1. Certifique-se de que seu dom√≠nio est√° apontando para o IP p√∫blico do EC2
2. Verifique se as portas 80 e 443 est√£o abertas no Security Group

```bash
sudo certbot --nginx -d seudominio.com -d www.seudominio.com
```

Siga as instru√ß√µes:
- Digite seu email
- Aceite os termos de servi√ßo
- Escolha se deseja compartilhar seu email (opcional)
- Escolha op√ß√£o 2 (redirecionar HTTP para HTTPS)

O Certbot ir√° automaticamente:
- Obter o certificado SSL
- Configurar o nginx para usar HTTPS
- Configurar renova√ß√£o autom√°tica

#### Passo 17: Verifique a Renova√ß√£o Autom√°tica

```bash
# Teste a renova√ß√£o (dry run)
sudo certbot renew --dry-run
```

O certificado ser√° renovado automaticamente antes de expirar.

### Parte 6: Configura√ß√£o de Firewall (Opcional mas Recomendado)

#### Passo 18: Configure o UFW

```bash
# Habilite UFW
sudo ufw allow 22/tcp     # SSH
sudo ufw allow 80/tcp     # HTTP
sudo ufw allow 443/tcp    # HTTPS
sudo ufw enable

# Verifique o status
sudo ufw status
```

---

## üîß Comandos √öteis

### Gerenciamento da Aplica√ß√£o (PM2)

```bash
# Ver status
pm2 status

# Ver logs
pm2 logs supply-tree

# Reiniciar aplica√ß√£o
pm2 restart supply-tree

# Parar aplica√ß√£o
pm2 stop supply-tree

# Ver monitoramento em tempo real
pm2 monit
```

### Gerenciamento do Nginx

```bash
# Testar configura√ß√£o
sudo nginx -t

# Recarregar configura√ß√£o
sudo systemctl reload nginx

# Reiniciar nginx
sudo systemctl restart nginx

# Ver logs de erro
sudo tail -f /var/log/nginx/error.log

# Ver logs de acesso
sudo tail -f /var/log/nginx/access.log
```

### Gerenciamento do PostgreSQL

```bash
# Acessar o PostgreSQL
sudo -u postgres psql supplytree

# Backup do banco de dados
pg_dump -U supplytree_user supplytree > backup_$(date +%Y%m%d).sql

# Restaurar backup
psql -U supplytree_user supplytree < backup.sql
```

### Atualiza√ß√£o da Aplica√ß√£o

```bash
# Navegue at√© o diret√≥rio
cd ~/supply-tree

# Baixe as atualiza√ß√µes
git pull

# Instale novas depend√™ncias (se houver)
npm install --production

# Execute migrations (se houver)
npm run db:push

# Rebuild da aplica√ß√£o
npm run build

# Reinicie a aplica√ß√£o
pm2 restart supply-tree

# Verifique os logs
pm2 logs supply-tree
```

---

## üîí Seguran√ßa em Produ√ß√£o

### Checklist de Seguran√ßa:

- ‚úÖ Use HTTPS (SSL/TLS) - Let's Encrypt
- ‚úÖ Configure `TRUST_PROXY=true` no .env
- ‚úÖ Use uma `SESSION_SECRET` forte e aleat√≥ria
- ‚úÖ Mantenha `NODE_ENV=production`
- ‚úÖ Configure CORS com dom√≠nios espec√≠ficos (n√£o use `*`)
- ‚úÖ Mantenha o sistema atualizado: `sudo apt update && sudo apt upgrade`
- ‚úÖ Use senhas fortes para PostgreSQL
- ‚úÖ Limite acesso SSH apenas ao seu IP no Security Group
- ‚úÖ Configure backups autom√°ticos do banco de dados
- ‚úÖ Monitore logs regularmente
- ‚úÖ Nunca fa√ßa commit do arquivo `.env`

---

## üìä Monitoramento

### CloudWatch (AWS)

Configure alarmes para:
- Uso de CPU > 80%
- Uso de disco > 80%
- Status da inst√¢ncia

### Logs da Aplica√ß√£o

```bash
# Ver logs em tempo real
pm2 logs supply-tree --lines 100

# Logs do nginx
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log

# Logs do sistema
sudo journalctl -u nginx -f
```

---

## üö® Troubleshooting

### Problema: Aplica√ß√£o n√£o inicia

```bash
# Verifique os logs do PM2
pm2 logs supply-tree

# Verifique vari√°veis de ambiente
cat .env

# Verifique se a porta est√° em uso
sudo netstat -tulpn | grep :5000
```

### Problema: Erro de conex√£o com banco de dados

```bash
# Verifique se o PostgreSQL est√° rodando
sudo systemctl status postgresql

# Teste a conex√£o
psql -U supplytree_user -d supplytree -h localhost

# Verifique a DATABASE_URL no .env
```

### Problema: 502 Bad Gateway

```bash
# Verifique se a aplica√ß√£o est√° rodando
pm2 status

# Verifique logs do nginx
sudo tail -f /var/log/nginx/error.log

# Verifique se o proxy_pass est√° correto no nginx
sudo nano /etc/nginx/sites-available/supply-tree
```

### Problema: SSL n√£o funciona

```bash
# Verifique certificados
sudo certbot certificates

# Renovar certificado manualmente
sudo certbot renew

# Verifique configura√ß√£o do nginx
sudo nginx -t
```

---

## üìû Suporte

Para problemas ou d√∫vidas, verifique:
1. Logs da aplica√ß√£o (`pm2 logs`)
2. Logs do nginx (`/var/log/nginx/`)
3. Vari√°veis de ambiente (`.env`)
4. Security Groups do EC2
5. Status dos servi√ßos (`systemctl status`)

---

## üéØ Pr√≥ximos Passos (Opcional)

### Melhorias Recomendadas para Produ√ß√£o:

1. **Use RDS para PostgreSQL**
   - Backups autom√°ticos
   - Alta disponibilidade
   - Melhor performance

2. **Configure um Load Balancer**
   - Distribua tr√°fego entre m√∫ltiplas inst√¢ncias
   - SSL/TLS gerenciado pela AWS

3. **Configure Auto Scaling**
   - Escala autom√°tica baseada em demanda
   - Reduz custos em per√≠odos de baixo uso

4. **Use CloudFront (CDN)**
   - Melhora performance global
   - Cache de assets est√°ticos

5. **Configure CI/CD**
   - Deploy autom√°tico via GitHub Actions
   - Testes automatizados

6. **Monitore com CloudWatch**
   - Dashboards customizados
   - Alarmes para m√©tricas cr√≠ticas

---

**‚ú® Parab√©ns! Sua aplica√ß√£o Supply TREE est√° rodando em produ√ß√£o!**
